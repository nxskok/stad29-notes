Trying a map of ontario

The Ontario hockey divisions (the last example for cluster analysis) came with a very bad map. Can we do better?

Packages (including some new ones):

```{r}
library(tmaptools)
library(leaflet)
library(tidyverse)
library(conflicted)
```

Ontario road distances

```{r}
my_url <- 
  "http://www.utsc.utoronto.ca/~butler/d29/ontario-road-distances.csv"
# my_url <- "ontario-road-distances.csv"
ontario <- read_csv(my_url)
ontario
```

Grab the places, and find their latitudes and longitudes ("geocode"). Save the geocoded places (this is the slowest part):

```{r}
tibble(place = ontario$place) %>% 
  mutate(prov = "ON") %>% 
  mutate(place1 = str_c(place, " ", prov)) %>% 
  rowwise() %>% 
  mutate(ll = list(geocode_OSM(place1))) -> d
```

untangle the lats and longs:

```{r}
d
d %>% unnest_wider(ll) %>% 
  unnest_wider(coords) -> coords
coords
```

make a map with the coords

```{r}
leaflet(data = coords) %>% 
  addTiles() %>% 
  addCircleMarkers(lng = ~x, lat = ~y) -> locs
locs
```

```{r}
# mapview::mapshot(locs, file = "map1.png")
```


cluster analysis

```{r}
ontario.d <- ontario %>% select(-1) %>% as.dist()
ontario.hc <- hclust(ontario.d, method = "ward.D")
```

7 clusters:

```{r fig.height=4} 
plot(ontario.hc)
rect.hclust(ontario.hc, 7)
```

get the clusters and combine the ones I want

```{r}
tibble(place = ontario$place, cluster = cutree(ontario.hc, 7)) -> clusters
clusters %>% arrange(cluster)
```

combine clusters 6 and 7 with 4 ("north")
combine clusters 2 and 3 ("east")
make named divisions

```{r}
clusters %>% 
  mutate(division = fct_collapse(factor(cluster),
                                "north" = c("4", "6", "7"),
                                "east" = c("2", "3"),
                                "west" = "5",
                                "central" = "1")) %>% 
  arrange(division) -> divisions
divisions
```

add the divisions to coords, matching by place

```{r}
pal <- colorFactor("Set1", divisions$division)

coords %>% left_join(divisions) %>% 
  select(place, x, y, division) %>% 
  leaflet() %>% 
  addTiles() %>% 
  addCircleMarkers(lng = ~x, lat = ~y, color = ~pal(division)) -> divmap
divmap
```

```{r}
# mapview::mapshot(divmap, file = "map2.png")
```

The same idea gets a map of the original seven clusters:

```{r}
pal <- colorFactor("Set1", divisions$cluster)
coords %>% left_join(divisions) %>% 
  select(place, x, y, cluster) %>% 
  leaflet() %>% 
  addTiles() %>% 
  addCircleMarkers(lng = ~x, lat = ~y, color = ~pal(cluster)) -> divmap
divmap
```
```

